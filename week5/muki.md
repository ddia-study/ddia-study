# 5장 - 복제

- 복제 : 여러 장비에 동일한 데이터의 복사본을 유지하는 것
    - 지리적으로 사용자와 가깝게 → 지연 시간 줄임
    - 장애 발생해도 지속적으로 동작 → 가용성 높임
    - 읽기 처리량 늘림
- 복제된 데이터의 변경? ← 어떻게 관리할 것인가
- 3가지 복제 - 단일 리더, 다중 리더, 리더 없는 복제
- 리더와 팔로워
    - 리더 기반 복제
        1. 리더가 먼저 로컬 저장소에 새로운 데이터 기록
        2. 변경 내용을 복제 로그, 변경 스트림의 일부로 팔로워에게 전송
        - 클라이언트에서 쓰기는 리더로만 가능, 읽기는 다 가능
    - 동기식 vs 비동기식
        - 동기식
            - 장점 - 팔로워와 리더가 일관성 있게 복사본 가짐을 보장
            - 단점 - 동기 팔로워가 죽으면 쓰기가 처리될 수 없다.(되 살아날때 까지 wait)
        - 반 동기식 - 팔로워 1개와만 동기식 + 나머지는 비동기(팔로워가 느려지면 교체)
        - 비동기식
            - 장점 : 모든 팔로워가 잘못되도 리더가 처리 가능
            - 단점 : 지속성을 보장 X(클라이언트 쓰기 확인 이어도 실제는 X)
    - 노드 중단 처리
        - 팔로워 장애(따라잡기 복구) - 결함이 발생하기 전 마지막 트랜책션 기준으로 따라잡기
        - 리더 장애(장애 복구)
            1. 리더 장애 판단 - timeout
            2. 새로운 리더 선택
            3. 새로운 리더 사용을 위한 시스템 재설정 - 클라이언트 리더 재설정, ...
    - 복제 로그 구현
        - 구문 기반 복제 - 구문을 팔로워에게 요청 → 비 결정형 Date...등이 존재 (결정형으로 변경)
        - 쓰기 전 로그 배송 - 로그를 팔로워에게 보냄 → 팔로워가 로그 대로 처리
        - 논리적 로그 복제 - 논리적 로그(로우 단위 쓰기 코드 열)를 보냄
        - 트리거 기반 복제 - 트리거를 사용하여 복제
    - 복제 지연 문제
        - 최종적 일관성 - db를 시간이 지나게 놔두면 최종적으로 데이터의 일관성 보장
        - 3가지 복제 지연 사례
            1. 자신이 쓴 내용 읽기 - 사용자가 쓰기를 수행한 직후 보는 것 - time stamp
            2. 단조 읽기 - 다른 복제 서버에서 여러 읽기 수행(시간 거꾸로 효과) - 동일한 복제 서버 읽기로
            3. 일관된 순서로 읽기 - 일련의 읽기가 특정 순서로 발생하면 모든 사용자가 같은 순서로 쓰여진 사용자 내용 보게됨
    
- 다중 리더 복제
    - 다중 데이터 센터 운영, 오프라인 작업을 하는 클라이언트, 협업 편집 등에서 사용
    - 쓰기 충돌 다루기
        1. 동기 대 비동기 충돌 감지 - 쓰기가 완료되고 알리기 ← 비효율
        2. 충돌 회피 - 한 데이터 센터로 몰기
        3. 일관된 상태 수렴 - 수렴의 방식, 최종값 전달
        4. 사용자 정의 충돌 해소 로직
- 리더 없는 복제
    - 쓰기 요청을 여러 노드에 읽기 시에도 여러 노드에 + 버전으로 최신 확인
    - 읽기와 쓰기를 위한 정족수 - 워크로드에 따라 설정
    - 동시 쓰기 감지(쓰기 충돌 다루기) ⇒ 최종 쓰기 승리 - 타임 스템프로 최종 쓰기를 받아들임
    - 버전 벡터 - 키당 복제 번호 뿐아니라 복제본당 버전 번호를 사용하는 것(복제본의 버전 번호 모음)
        
        
- 정리
    - 복제는 고가용성, 연결이 끊긴 작업, 지연 시간, 확장성 등의 용도로 사용 가능
    - 복제는 동기  vs 비동기로 이루어짐
    - 복제 지연시 일관성 모델
        1. 쓰기 후 읽기 일관성 - 사용자는 자신이 제출한 데이터를 항상 볼 수 있어야 한다.
        2. 단조 읽기 - 사용자가 어떤 시점에 데이터를 본 후에는 예전 시점의 데이터는 나중에 볼 수 없다.
        3. 일관된 순서로 읽기 - 사용자는 인과성이 있는 상태의 데이터를 봐야 한다.

---